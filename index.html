<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConvoSpace</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzfN_BtTw0JMgkn9D5apkrH9h4QV0jwY0",
            authDomain: "convospace-e4d4f.firebaseapp.com",
            databaseURL: "https://convospace-e4d4f-default-rtdb.firebaseio.com",
            projectId: "convospace-e4d4f",
            storageBucket: "convospace-e4d4f.appspot.com",
            messagingSenderId: "239356822811",
            appId: "1:239356822811:web:33db35f2243c2161f03fbe",
            measurementId: "G-TMWZSHDBQL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // UI Elements
        const authSection = document.getElementById('auth-section');
        const userInfoSection = document.getElementById('user-info');
        const usernameInput = document.getElementById('username');
        const registerButton = document.getElementById('register-button');
        const loginAnonymousButton = document.getElementById('login-anonymous');
        const loginGoogleButton = document.getElementById('login-google');
        const logoutButton = document.getElementById('logout');
        const communityNameInput = document.getElementById('community-name');
        const createCommunityButton = document.getElementById('create-community');
        const communitiesList = document.getElementById('communities-list');
        const currentCommunityName = document.getElementById('current-community-name');
        const postInput = document.getElementById('post-input');
        const postImageInput = document.getElementById('post-image');
        const postButton = document.getElementById('post-button');
        const postsList = document.getElementById('posts-list');
        const communityPostSection = document.getElementById('community-post-section');
        const userNameSpan = document.getElementById('user-name');

        // Authentication listeners
        auth.onAuthStateChanged((user) => {
            if (user) {
                showUserInfo(user);
            } else {
                showAuthSection();
            }
        });

        // Show user info
        function showUserInfo(user) {
            authSection.classList.add("hidden");
            userInfoSection.classList.remove("hidden");
            userNameSpan.textContent = usernameInput.value || "Anonymous User";

            // Fetch communities
            fetchCommunities();
        }

        // Show authentication section
        function showAuthSection() {
            authSection.classList.remove("hidden");
            userInfoSection.classList.add("hidden");
        }

        // Register a new user with email and password
        registerButton.addEventListener('click', () => {
            const email = prompt("Enter your email:");
            const password = prompt("Enter your password:");
            if (email && password) {
                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        showUserInfo(userCredential.user);
                    })
                    .catch((error) => {
                        console.error("Error registering user:", error);
                    });
            }
        });

        // Login anonymously
        loginAnonymousButton.addEventListener('click', () => {
            signInAnonymously(auth).then((userCredential) => {
                showUserInfo(userCredential.user);
            }).catch((error) => {
                console.error("Error logging in anonymously:", error);
            });
        });

        // Create a community
        createCommunityButton.addEventListener('click', () => {
            const communityName = communityNameInput.value;
            if (communityName) {
                const communityRef = ref(db, 'communities/' + communityName);
                set(communityRef, {
                    name: communityName
                }).then(() => {
                    communityNameInput.value = '';
                    fetchCommunities();
                }).catch((error) => {
                    console.error("Error creating community:", error);
                });
            }
        });

        // Fetch and display communities
        function fetchCommunities() {
            const communitiesRef = ref(db, 'communities/');
            get(communitiesRef).then((snapshot) => {
                communitiesList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const community = childSnapshot.val();
                    const li = document.createElement('li');
                    li.textContent = community.name;
                    li.addEventListener('click', () => joinCommunity(community.name));
                    communitiesList.appendChild(li);
                });
            }).catch((error) => {
                console.error("Error fetching communities:", error);
            });
        }

        // Join a community
        function joinCommunity(communityName) {
            currentCommunityName.textContent = communityName;
            postButton.onclick = () => postMessage(communityName);
            communityPostSection.classList.remove('hidden');
            fetchPosts(communityName);
        }

        // Post message in a community
        function postMessage(communityName) {
            const postText = postInput.value;
            const imageFile = postImageInput.files[0];

            const postRef = ref(db, 'communities/' + communityName + '/posts');
            const newPostRef = push(postRef);

            if (imageFile) {
                const imageRef = storageRef(storage, `images/${newPostRef.key}`);
                uploadBytes(imageRef, imageFile).then(() => {
                    return getDownloadURL(imageRef);
                }).then((downloadURL) => {
                    set(newPostRef, {
                        text: postText,
                        image: downloadURL,
                        user: userNameSpan.textContent,
                        timestamp: Date.now()
                    }).then(() => {
                        postInput.value = '';
                        postImageInput.value = '';
                        fetchPosts(communityName);
                    });
                }).catch((error) => {
                    console.error("Error uploading image:", error);
                });
            } else {
                set(newPostRef, {
                    text: postText,
                    user: userNameSpan.textContent,
                    timestamp: Date.now()
                }).then(() => {
                    postInput.value = '';
                    fetchPosts(communityName);
                }).catch((error) => {
                    console.error("Error posting message:", error);
                });
            }
        }

        // Fetch and display posts in the community
        function fetchPosts(communityName) {
            const postsRef = ref(db, 'communities/' + communityName + '/posts');
            get(postsRef).then((snapshot) => {
                postsList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const post = childSnapshot.val();
                    const postElement = document.createElement('div');
                    postElement.className = 'post';

                    const textElement = document.createElement('p');
                    textElement.textContent = post.text;

                    if (post.image) {
                        const imgElement = document.createElement('img');
                        imgElement.src = post.image;
                        imgElement.alt = 'Posted Image';
                        imgElement.className = 'post-image';
                        postElement.appendChild(imgElement);
                    }

                    const userElement = document.createElement('small');
                    userElement.textContent = `Posted by: ${post.user} on ${new Date(post.timestamp).toLocaleString()}`;
                    
                    postElement.appendChild(textElement);
                    postElement.appendChild(userElement);
                    postsList.appendChild(postElement);
                });
            }).catch((error) => {
                console.error("Error fetching posts:", error);
            });
        }

        // Logout
        logoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                showAuthSection();
            }).catch((error) => {
                console.error("Error logging out:", error);
            });
        });
    </script>
</head>
<body>
    <div id="auth-section">
        <h2>Login or Register</h2>
        <button id="register-button">Register</button>
        <button id="login-anonymous">Login Anonymously</button>
        <button id="login-google">Login with Google</button>
    </div>

    <div id="user-info" class="hidden">
        <h2>Welcome, <span id="user-name"></span></h2>
        <button id="logout">Logout</button>
        <h3>Create a Community</h3>
        <input type="text" id="community-name" placeholder="Community Name">
        <button id="create-community">Create</button>
        <h3>Available Communities</h3>
        <ul id="communities-list"></ul>
    </div>

    <div id="community-post-section" class="hidden">
        <h2>Current Community: <span id="current-community-name"></span></h2>
        <textarea id="post-input" placeholder="What's on your mind?"></textarea>
        <input type="file" id="post-image" accept="image/*">
        <button id="post-button">Post</button>
        <h3>Posts</h3>
        <div id="posts-list"></div>
    </div>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h2 {
            color: #333;
        }
        #auth-section, #user-info, #community-post-section {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        .post {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
            border-radius: 5px;
        }
        .post-image {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
        }
    </style>
</body>
</html>
